<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compressor Tool Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .test-result {
            margin: 5px 0;
            padding: 5px;
            background-color: #f5f5f5;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
    <script>
        // Define Module configuration before loading coolprop.js
        var Module = {
            locateFile: function(path) {
                if(path.endsWith('.wasm')) {
                    return 'coolprop/' + path;
                }
                return path;
            },
            onRuntimeInitialized: function() {
                logMessage('WASM runtime initialized');
                checkCoolPropStatus();
            }
        };
    </script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- CoolProp.js -->
    <script src="coolprop/coolprop.js"></script>
</head>
<body>
    <h1>Compressor Tool Diagnostic</h1>
    
    <div class="step">
        <h2>Step 1: Check Script Loading</h2>
        <div id="script-status">Checking scripts...</div>
    </div>
    
    <div class="step">
        <h2>Step 2: Check CoolProp Module</h2>
        <div id="coolprop-status">Checking CoolProp...</div>
        <button onclick="checkCoolPropStatus()">Check Again</button>
    </div>
    
    <div class="step">
        <h2>Step 3: Test Basic CoolProp Functions</h2>
        <div id="coolprop-test">Not tested yet</div>
        <button onclick="testCoolProp()">Run Test</button>
    </div>
    
    <div class="step">
        <h2>Step 4: Test Full Calculation</h2>
        <div id="calc-test">Not tested yet</div>
        <button onclick="testFullCalculation()">Run Full Test</button>
    </div>
    
    <div class="step">
        <h2>Logs</h2>
        <div id="log"></div>
    </div>
    
    <script>
        // Helper function to log messages
        function logMessage(msg) {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML = `<div>[${timestamp}] ${msg}</div>` + log.innerHTML;
            console.log(`[${timestamp}] ${msg}`);
        }
        
        // Check if scripts are loaded
        function checkScripts() {
            const status = document.getElementById('script-status');
            
            if (typeof Plotly !== 'undefined') {
                status.innerHTML += '<div class="test-result success">Plotly.js loaded successfully</div>';
            } else {
                status.innerHTML += '<div class="test-result error">Plotly.js not loaded</div>';
            }
            
            if (typeof Module !== 'undefined') {
                status.innerHTML += '<div class="test-result success">Module defined</div>';
            } else {
                status.innerHTML += '<div class="test-result error">Module not defined</div>';
            }
            
            if (typeof CoolProp !== 'undefined') {
                status.innerHTML += '<div class="test-result success">CoolProp object exists</div>';
            } else {
                status.innerHTML += '<div class="test-result error">CoolProp object not found</div>';
            }
        }
        
        // Check CoolProp module status
        function checkCoolPropStatus() {
            const status = document.getElementById('coolprop-status');
            status.innerHTML = 'Checking CoolProp status...';
            
            if (typeof CoolProp === 'undefined') {
                status.innerHTML = '<div class="error">CoolProp is undefined</div>';
                return;
            }
            
            status.innerHTML = '<div class="test-result">CoolProp object exists</div>';
            
            // Check properties and methods
            if (typeof CoolProp.PropsSI === 'function') {
                status.innerHTML += '<div class="test-result success">CoolProp.PropsSI is a function</div>';
            } else {
                status.innerHTML += '<div class="test-result error">CoolProp.PropsSI is not a function</div>';
            }
            
            // Log CoolProp object properties for debugging
            try {
                status.innerHTML += '<div class="test-result">CoolProp object keys: ' + 
                    Object.keys(CoolProp).join(', ') + '</div>';
            } catch(e) {
                status.innerHTML += '<div class="test-result error">Error getting CoolProp keys: ' + e.message + '</div>';
            }
        }
        
        // Test basic CoolProp functions
        function testCoolProp() {
            const testDiv = document.getElementById('coolprop-test');
            testDiv.innerHTML = 'Running tests...';
            
            if (typeof CoolProp === 'undefined') {
                testDiv.innerHTML = '<div class="error">CoolProp is undefined</div>';
                return;
            }
            
            if (typeof CoolProp.PropsSI !== 'function') {
                testDiv.innerHTML = '<div class="error">CoolProp.PropsSI is not a function</div>';
                return;
            }
            
            try {
                // Test a simple calculation
                const temperature = 300; // K
                const pressure = 101325; // Pa
                const fluid = 'Air';
                
                const density = CoolProp.PropsSI('D', 'T', temperature, 'P', pressure, fluid);
                testDiv.innerHTML = '<div class="test-result">Density of Air: ' + density.toFixed(3) + ' kg/m³</div>';
                
                const enthalpy = CoolProp.PropsSI('H', 'T', temperature, 'P', pressure, fluid);
                testDiv.innerHTML += '<div class="test-result">Enthalpy of Air: ' + enthalpy.toFixed(1) + ' J/kg</div>';
                
                const entropy = CoolProp.PropsSI('S', 'T', temperature, 'P', pressure, fluid);
                testDiv.innerHTML += '<div class="test-result">Entropy of Air: ' + entropy.toFixed(1) + ' J/kg-K</div>';
                
                testDiv.innerHTML += '<div class="success">Basic CoolProp tests passed!</div>';
            } catch (error) {
                testDiv.innerHTML = '<div class="error">Error during CoolProp test: ' + error.message + '</div>';
                console.error(error);
            }
        }
        
        // Test full calculation
        function testFullCalculation() {
            const testDiv = document.getElementById('calc-test');
            testDiv.innerHTML = 'Running full calculation...';
            
            try {
                // Input parameters
                const p_in = 100000;  // Pa
                const p_out = 700000;  // Pa
                const mass_flow_rate = 0.85;  // kg/s
                const efficiency = 0.9;
                const temp_ref = 35;  // °C
                const t_ref_k = temp_ref + 273.15;  // K
                const fluid = 'Air';
                
                // Calculate reference values
                const h1_ref = CoolProp.PropsSI('H', 'T', t_ref_k, 'P', p_in, fluid);
                const s1_ref = CoolProp.PropsSI('S', 'T', t_ref_k, 'P', p_in, fluid);
                const h2s_ref = CoolProp.PropsSI('H', 'P', p_out, 'S', s1_ref, fluid);
                const w_ref = (h2s_ref - h1_ref) / efficiency;
                const p_ref = mass_flow_rate * w_ref / 1000;  // kW
                
                testDiv.innerHTML = '<div class="test-result">Reference power at ' + temp_ref + '°C: ' + p_ref.toFixed(2) + ' kW</div>';
                
                // Calculate for 20°C
                const t_test = 20 + 273.15;  // K
                const h1 = CoolProp.PropsSI('H', 'T', t_test, 'P', p_in, fluid);
                const s1 = CoolProp.PropsSI('S', 'T', t_test, 'P', p_in, fluid);
                const h2s = CoolProp.PropsSI('H', 'P', p_out, 'S', s1, fluid);
                const w = (h2s - h1) / efficiency;
                const power = mass_flow_rate * w / 1000;  // kW
                const savings = 100 * (1 - power / p_ref);
                
                testDiv.innerHTML += '<div class="test-result">Power at 20°C: ' + power.toFixed(2) + ' kW</div>';
                testDiv.innerHTML += '<div class="test-result">Savings vs reference: ' + savings.toFixed(2) + '%</div>';
                
                testDiv.innerHTML += '<div class="success">Full calculation test passed!</div>';
            } catch (error) {
                testDiv.innerHTML = '<div class="error">Error during full calculation: ' + error.message + '</div>';
                console.error(error);
            }
        }
        
        // Run initial script checks
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('Page loaded');
            checkScripts();
        });
    </script>
</body>
</html>
